(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{125:function(e,t,n){"use strict";n.r(t);var a=n(0),r=n.n(a),i=n(8),c=n.n(i),o=(n(94),n(11)),u=n(83),s=n.n(u),l=n(82),f=n.n(l),d=n(36);function m(e){var t=e.set,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:n,a=arguments.length>1?arguments[1]:void 0;switch(a.type){case t:return a.payload;default:return e}}}var p={treeFeatures:{request:"treeFeaturesRequest",success:"treeFeaturesSuccess",fail:"treeFeaturesFail"},historyEntries:{request:"historyEntriesRequest",success:"historyEntriesSuccess",fail:"historyEntriesFail"},sideSheetViewId:{set:"setSideSheetViewId"},selections:{set:"setSelections"},isEditing:{set:"setEditing"}},g=n(21),v=n(25);var b,h=(b=function(e){return e.id},function(e){return Object.values(e).reduce(function(e,t){return Object(g.a)({},e,Object(v.a)({},b(t),t))},{})}),O=function(e){var t=e.success;return function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1?arguments[1]:void 0;switch(n.type){case t:return Object(g.a)({},e,h(n.payload.entities));default:return e}}},E=function(e){var t=e.request,n=e.success,a=e.fail;return function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=arguments.length>1?arguments[1]:void 0;switch(r.type){case t:return Object(g.a)({},e,Object(v.a)({},r.payload.viewId,{meta:{fetching:!0,error:!1},ids:[]}));case n:return Object(g.a)({},e,Object(v.a)({},r.payload.viewId,{meta:{fetching:!1,error:!1},ids:r.payload.entities.map(function(e){return e.id})}));case a:return Object(g.a)({},e,Object(v.a)({},r.payload.viewId,{meta:{fetching:!1,error:!0},ids:[]}));default:return e}}};function j(e){return Object(d.a)({byId:O(e),views:E(e)})}var w,y=(w=Object(d.a)({network:Object(d.a)({treeFeatures:j(p.treeFeatures),historyEntries:j(p.historyEntries)}),app:Object(d.a)({selections:m(p.selections,[]),isEditing:m(p.isEditing,!1)})}),function(e,t){return t.reduce(function(e,t){return w(e,t)},e)}),I=Object(a.createContext)(),k=n(63),C=window.giscloud,N="9ada0e4a4183b348d7df",F=1082904,S="giscloud_api_test_history",R=Object(k.a)({mapViewer:{height:"100vh",width:"100vw"}});var x=function(e){var t=e.onSelectionChange,n=e.viewerRef,i=e.token,c=Object(a.useState)(null),u=Object(o.a)(c,2),s=u[0],l=u[1],f=R();return Object(a.useEffect)(function(){if(null!=C.oauth2.token()){var e=new C.Viewer("mapViewer",F,{slider:!0});l(e),window.viewer=e,n.current=e,e.loading.then(function(){e.select(!0)})}},[n,t,i]),Object(a.useEffect)(function(){null!=s&&s.loading.then(function(){s.selectionChange(t)})},[t,s]),r.a.createElement("div",null,r.a.createElement("div",{id:"mapViewer",className:f.mapViewer}))},T=n(165),B=n(160),_=n(157),q=n(55);function L(e){var t=Object.values(e).find(function(e){return"number"!==typeof e&&"string"!==typeof e});if(void 0!==t)throw new Error("Only numbers and strings are allowed. Found ".concat(t," (").concat(typeof t,")."));return"{".concat(Object.entries(e).sort(function(e,t){var n=Object(o.a)(e,1)[0],a=Object(o.a)(t,1)[0];return n<a?-1:n>a?1:0}).map(function(e){var t=Object(o.a)(e,2),n=t[0],a=t[1];return"".concat(n,": ").concat(a)}).join(", "),"}")}function V(e){var t=e.success;return function(e,n){return{type:t,payload:{viewId:e,entities:n}}}}function P(e){var t=e.request;return function(e){return{type:t,payload:{viewId:e}}}}var z=V(p.treeFeatures),D=P(p.treeFeatures),J=V(p.historyEntries),W=P(p.historyEntries);function M(e){return{type:p.selections.set,payload:e.current?e.current.selection.selected().map(function(e){var t=e.featureId,n=e.layerId;return{featureId:Number(t),layerId:n}}):[]}}var Q=n(163);function $(e,t){var n=L({treeId:t});e([W(n)]),new C.Query(S,{geometry:!1}).where("tree_id","=",t).find().then(function(e){return e.data.map(function(e){return Object(g.a)({id:e.ogc_fid},e)})}).then(function(t){e([J(n,t)])})}var A=Object(k.a)(function(e){return{form:{display:"flex",flexDirection:"column"},input:{marginTop:e.spacing(2),marginLeft:e.spacing(3),marginRight:e.spacing(3)},button:{marginTop:e.spacing(2),marginLeft:e.spacing(3),marginRight:e.spacing(3)},error:{marginTop:e.spacing(2),marginLeft:e.spacing(3),marginRight:e.spacing(3)}}});function G(){var e=A(),t=Object(a.useContext)(I),n=Object(o.a)(t,2),i=n[0],c=n[1],u=Object(a.useState)(""),s=Object(o.a)(u,2),l=s[0],f=s[1],d=Object(a.useState)(!1),m=Object(o.a)(d,2),p=m[0],g=m[1],v=Object(a.useState)(null),b=Object(o.a)(v,2),h=b[0],O=b[1],E=Object(a.useCallback)(function(e){var t=e.target.value;return f(t)},[f]),j=(i.app.selections[0]||{}).featureId,w=Object(a.useCallback)(function(e){e.preventDefault(),g(!0),C.tables.rows.add(S,{data:{tree_id:j,description:l}}).then(function(){f("")}).fail(function(e){O(e)}).always(function(){g(!1)}).then(function(){$(c,j)})},[j,l,c]);return r.a.createElement("form",{onSubmit:w,className:e.form},r.a.createElement(Q.a,{variant:"outlined",autoFocus:!0,className:e.input,value:l,onChange:E,required:!0}),r.a.createElement(_.a,{color:"primary",variant:"contained",className:e.button,disabled:p},p?"\u9001\u4fe1\u4e2d":"\u9001\u4fe1"),h?r.a.createElement(q.a,{color:"error",className:e.error},"\u9001\u4fe1\u306b\u5931\u6557\u3057\u307e\u3057\u305f\u3002"):null)}var H=n(159),K=n(126),U=n(158);function X(e){var t=e.description,n=e.__created,a=function(e){return new Date(e.getTime()-6e4*e.getTimezoneOffset())}(new Date(n));return r.a.createElement(K.a,null,r.a.createElement(U.a,{primary:t,secondary:a.toLocaleString()}))}function Y(e){var t,n=e.treeId,i=e.className,c=Object(a.useContext)(I),u=Object(o.a)(c,1)[0],s=L({treeId:n}),l=u.network.historyEntries.views[s];if(null==l)t=null;else if(l.meta.fetching)t=r.a.createElement(H.a,null);else if(l.meta.error)t="error";else{t=l.ids.map(function(e){return u.network.historyEntries.byId[e]}).map(function(e){return r.a.createElement(X,Object.assign({},e,{key:e.id}))})}return r.a.createElement("div",{className:i},t)}Y.defaultProps={className:null};var Z=Object(k.a)(function(e){return{drawerPaper:{width:400},title:{marginTop:e.spacing(3),marginLeft:e.spacing(3),marginRight:e.spacing(3)},button:{marginTop:e.spacing(2),marginLeft:e.spacing(3),marginRight:e.spacing(3)},historyEntries:{marginTop:e.spacing(2),marginLeft:e.spacing(1),marginRight:e.spacing(1)}}});function ee(e){var t,n=e.onClose,i=Z(),c=Object(a.useContext)(I),u=Object(o.a)(c,2),s=u[0],l=function(e){return Object(a.useCallback)(function(){var t;e([(t=!0,{type:p.isEditing.set,payload:t})])},[e])}(u[1]),f=function(e){if(null==e.app.selections[0])return null;var t=L({id:e.app.selections[0].featureId});return e.network.treeFeatures.views[t]}(s);if(null==f)t=null;else if(f.meta.fetching)t=r.a.createElement(B.a,null);else if(f.meta.error)t="fetching";else{var d=function(e,t){var n=t.ids[0];return e.network.treeFeatures.byId[n].data}(s,f);t=r.a.createElement(r.a.Fragment,null,r.a.createElement(q.a,{variant:"h5",className:i.title},d.name),s.app.isEditing?r.a.createElement(G,null):r.a.createElement(_.a,{color:"primary",variant:"contained",className:i.button,onClick:l},"\u4f5c\u696d\u3092\u8a18\u9332"),r.a.createElement(Y,{treeId:f.ids[0],className:i.historyEntries}))}return r.a.createElement(T.a,{open:null!=f,onClose:n,classes:{paper:i.drawerPaper}},t)}function te(e){var t=e.className;return r.a.createElement(_.a,{variant:"contained",color:"primary",onClick:function(){C.oauth2.signIn()},className:t},"\u30ed\u30b0\u30a4\u30f3")}te.defaultProps={className:null};var ne=te,ae=n(84),re=n(162),ie=n(161),ce=n(81),oe=n.n(ce);function ue(e){var t=e.className,n=Object(a.useState)(null),i=Object(o.a)(n,2),c=i[0],u=i[1];function s(){u(null)}return r.a.createElement(r.a.Fragment,null,r.a.createElement(ie.a,{className:t,onClick:function(e){var t=e.currentTarget;u(t)}},r.a.createElement(oe.a,null)),r.a.createElement(ae.a,{anchorEl:c,open:Boolean(c),onClose:s,keepMounted:!0},r.a.createElement(re.a,{onClick:function(){s(),C.oauth2.signOut()}},"\u30ed\u30b0\u30a2\u30a6\u30c8")))}var se=Object(k.a)(function(e){return{settingsButton:{position:"absolute",right:e.spacing(1),top:e.spacing(1),zIndex:e.zIndex.appBar},authButton:{margin:"auto",display:"block",top:"50%"}}});var le=function(e){var t=e.dispatch,n=Object(a.useRef)(null),i=function(e,t){return Object(a.useCallback)(function(n){if(e([M(t)]),"add"===n.action){var a=n.feature.featureId,r=L({id:a});e([D(r)]),C.features.byId(n.feature.layerId,n.feature.featureId).then(function(t){e([z(r,[t])])}),$(e,a)}},[e,t])}(t,n),c=function(e){return Object(a.useCallback)(function(){null!=e.current&&e.current.selection.clear()},[e])}(n),u=se(),s=function(){var e=Object(a.useState)(null),t=Object(o.a)(e,2),n=t[0],r=t[1];return Object(a.useEffect)(function(){C.oauth2.authorize(N,function(){var e=C.oauth2.token();n!==e&&r(e)})},[n]),[n]}(),l=Object(o.a)(s,1)[0];return r.a.createElement(r.a.Fragment,null,l?r.a.createElement(r.a.Fragment,null,r.a.createElement(ue,{className:u.settingsButton}),r.a.createElement(ee,{onClose:c}),r.a.createElement(x,{onSelectionChange:i,viewerRef:n,token:l})):r.a.createElement(ne,{className:u.authButton}))},fe=y(void 0,[{type:null}]),de=f()({});var me=function(){var e=Object(a.useReducer)(y,fe),t=Object(o.a)(e,2),n=t[0],i=t[1];return r.a.createElement(s.a,{theme:de},r.a.createElement(I.Provider,{value:[n,i]},r.a.createElement(le,{dispatch:i})))};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));C.ready(function(){c.a.render(r.a.createElement(me,null),document.getElementById("root"))}),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(function(e){e.unregister()})},89:function(e,t,n){e.exports=n(125)},94:function(e,t,n){}},[[89,1,2]]]);
//# sourceMappingURL=main.9e859574.chunk.js.map